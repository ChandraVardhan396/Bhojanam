<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Food Label Copilot</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<!-- Mocking the qtwebchannel for the preview environment -->
<script>
  if (typeof qt === "undefined") {
    window.qt = { webChannelTransport: {} };
    window.QWebChannel = function(transport, callback) {
      console.log("Mock WebChannel Initialized");
      const mockChannel = {
        objects: {
          copilot: {
            loading: { connect: () => {} },
            resultReady: { connect: () => {} },
            scan_window: () => console.log("Scanning window..."),
            upload_image: () => console.log("Uploading image..."),
            capture_camera: () => console.log("Capturing camera...")
          }
        }
      };
      callback(mockChannel);
    };
  }
</script>
<script src="qrc:///qtwebchannel/qwebchannel.js"></script>

<style>
/* =========================
   MODERN RESET & VARS
========================= */
:root {
  --glass-bg: rgba(20, 20, 22, 0.75);
  --card-bg: rgba(255, 255, 255, 0.05);
  --card-border: rgba(255, 255, 255, 0.12);
  --accent-gradient: linear-gradient(135deg, #c587e4 0%, #a855f7 100%);
  --text-main: #ffffff;
  --text-muted: rgba(255, 255, 255, 0.5);
}

* {
  box-sizing: border-box;
  -webkit-font-smoothing: antialiased;
}

html, body {
  margin: 0;
  padding: 0;
  width: 100%;
  height: 100%;
  background: #0f172a; /* Fallback dark background */
  overflow: hidden;
  font-family: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
  color: var(--text-main);
}

/* =========================
   MAIN WINDOW (ULTRA GLASS)
========================= */
.copilot {
  position: relative;
  height: 100vh;
  display: flex;
  flex-direction: column;
  background: var(--glass-bg);
  backdrop-filter: blur(40px) saturate(180%);
  -webkit-backdrop-filter: blur(40px) saturate(180%);
  border: 1px solid var(--card-border);
  border-radius: 24px;
  overflow: hidden;
  box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.8);
}

/* Background Mesh Glow */
.copilot::before {
  content: "";
  position: absolute;
  top: -15%;
  right: -15%;
  width: 50%;
  height: 50%;
  background: radial-gradient(circle, rgba(168, 85, 247, 0.15) 0%, transparent 70%);
  z-index: -1;
}

.copilot::after {
  content: "";
  position: absolute;
  bottom: -15%;
  left: -15%;
  width: 50%;
  height: 50%;
  background: radial-gradient(circle, rgba(99, 102, 241, 0.1) 0%, transparent 70%);
  z-index: -1;
}

/* =========================
   HEADER
========================= */
.header {
  height: 56px;
  padding: 0 20px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: rgba(255, 255, 255, 0.02);
  border-bottom: 1px solid var(--card-border);
}

.title-group {
  display: flex;
  align-items: center;
  gap: 10px;
}

.title-icon {
  width: 28px;
  height: 28px;
  background: var(--accent-gradient);
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  font-weight: 800;
  box-shadow: 0 4px 10px rgba(99, 102, 241, 0.3);
}

.title {
  font-size: 16px;
  font-weight: 700;
  letter-spacing: -0.3px;
  background: linear-gradient(to right, #ffffff, #94a3b8);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.close-btn {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
  cursor: pointer;
  background: rgba(255, 255, 255, 0.05);
}

.close-btn:hover { 
  background: rgba(239, 68, 68, 0.2); 
  transform: rotate(90deg);
}

/* =========================
   CONTENT AREA
========================= */
.content {
  flex: 1;
  padding: 16px;
  display: flex;
  flex-direction: column;
  gap: 12px;
  overflow: hidden; /* Prevent outer scroll so layout stays stable */
}

/* Scrollbar styling */
.result-display::-webkit-scrollbar {
  width: 4px;
}
.result-display::-webkit-scrollbar-track {
  background: transparent;
}
.result-display::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.15);
  border-radius: 10px;
}

/* =========================
   CARDS
========================= */
.card {
  background: var(--card-bg);
  border: 1px solid var(--card-border);
  border-radius: 20px;
  padding: 12px 16px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
}

/* Detection Source card is fixed at the top */
.card-detection {
  flex-shrink: 0;
}

/* Analysis Insights card takes remaining space */
.card-analysis {
  flex: 1;
  display: flex;
  flex-direction: column;
  min-height: 0; /* Important for inner scrolling */
}

.card:hover {
  border-color: rgba(255, 255, 255, 0.2);
  background: rgba(255, 255, 255, 0.07);
}

.card h3 {
  margin: 0 0 6px 0;
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: var(--text-muted);
}

.card p.desc {
  margin: 0;
  font-size: 13px;
  line-height: 1.4;
  color: rgba(255, 255, 255, 0.8);
}

/* =========================
   BUTTONS (SMALLER)
========================= */
.button-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 8px;
  margin-top: 12px;
}

button {
  background: rgba(255, 255, 255, 0.04);
  border: 1px solid var(--card-border);
  color: #fff;
  padding: 8px 6px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 4px;
}

button:hover {
  background: var(--accent-gradient);
  border-color: transparent;
  transform: translateY(-2px);
  box-shadow: 0 6px 12px -3px rgba(99, 102, 241, 0.4);
}

button:active { 
  transform: translateY(0); 
}

button svg {
  width: 20px;
  height: 20px;
  opacity: 0.8;
}

/* =========================
   RESULT CONTENT (SCROLLABLE)
========================= */
.result-display {
  background: rgba(0, 0, 0, 0.2);
  border-radius: 14px;
  padding: 12px 14px;
  flex: 1;
  overflow-y: auto;
  border-left: 3px solid #a855f7;
  position: relative;
}

.result-display p {
  margin: 0 0 10px 0;
  font-size: 13.5px;
  line-height: 1.5;
  color: rgba(255, 255, 255, 0.9);
}

/* Special formatting for **bold** text */
.gradient-bold {
  font-weight: 800;
  background: var(--accent-gradient);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

/* =========================
   LOADER
========================= */
.loader {
  position: absolute;
  inset: 0;
  background: rgba(10, 10, 12, 0.9);
  backdrop-filter: blur(12px);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 100;
  transition: opacity 0.4s ease, visibility 0.4s;
}

.spinner-box {
  position: relative;
  width: 48px;
  height: 48px;
}

.spinner {
  width: 100%;
  height: 100%;
  border: 3px solid rgba(255, 255, 255, 0.05);
  border-top: 3px solid #6366f1;
  border-right: 3px solid #a855f7;
  border-radius: 50%;
  animation: spin 1s cubic-bezier(0.5, 0, 0.5, 1) infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.loader-text {
  margin-top: 16px;
  font-size: 12px;
  font-weight: 600;
  letter-spacing: 0.5px;
  background: var(--accent-gradient);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 0.6; }
  50% { opacity: 1; }
}

.hidden { 
  opacity: 0; 
  visibility: hidden;
  pointer-events: none; 
}

/* =========================
   FOOTER
========================= */
.footer {
  padding: 10px;
  text-align: center;
  font-size: 11px;
  font-weight: 500;
  color: var(--text-muted);
  background: rgba(255, 255, 255, 0.01);
  border-top: 1px solid var(--card-border);
}
</style>
</head>

<body>
<div class="copilot">

  <!-- Loader -->
  <div id="loader" class="loader hidden">
    <div class="spinner-box">
      <div class="spinner"></div>
    </div>
    <div class="loader-text">AI IS ANALYZING...</div>
  </div>

  <!-- Header -->
  <div class="header">
    <div class="title-group">
      <div class="title-icon">AI</div>
      <div class="title">Food Label Copilot</div>
    </div>
  </div>

  <!-- Content -->
  <div class="content">

    <!-- Sticky Detection Source -->
    <div class="card card-detection">
      <h3>Detection Source</h3>
      <p class="desc">Scan nutrition labels instantly.</p>

      <div class="button-grid">
        <button onclick="scanWindow()">
          <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 7V5a2 2 0 012-2h2m10 0h2a2 2 0 012 2v2m0 10v2a2 2 0 01-2 2h-2M7 21H5a2 2 0 01-2-2v-2"></path></svg>
          Window
        </button>
        <button onclick="uploadImage()">
          <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
          Upload
        </button>
        <button onclick="captureCamera()">
          <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
          Camera
        </button>
      </div>
    </div>

    <!-- Scrolling Insights -->
    <div class="card card-analysis">
      <h3>Analysis Insights</h3>
      <div id="result" class="result-display">
        <p style="color: var(--text-muted); font-style: italic;">Waiting for input data...</p>
      </div>
    </div>

  </div>

  <div class="footer">
    Next-Gen Food Intelligence System
  </div>
</div>

<script>
(function () {
  const loader = document.getElementById("loader");
  const resultBox = document.getElementById("result");
  const buttons = document.querySelectorAll("button");

  function setLoading(v) {
    if (v) {
      loader.classList.remove("hidden");
    } else {
      loader.classList.add("hidden");
    }
    buttons.forEach(b => b.disabled = v);
  }

  function renderResult(text) {
    try {
      // Step 1: Replace **text** with <span class="gradient-bold">text</span>
      const formattedText = String(text).replace(/\*\*(.*?)\*\*/g, '<span class="gradient-bold">$1</span>');

      // Step 2: Split by lines and render as paragraphs
      const lines = formattedText.split("\n").filter(l => l.trim());
      resultBox.innerHTML = lines.map(l => `<p>${l}</p>`).join("");
      resultBox.scrollTop = 0;
    } catch (e) {
      resultBox.innerHTML = "<p>Error displaying results.</p>";
    }
  }

  function initWebChannel() {
    if (typeof qt === "undefined" || !qt.webChannelTransport) {
      setTimeout(initWebChannel, 100);
      return;
    }

    new QWebChannel(qt.webChannelTransport, function (channel) {
      const copilot = channel.objects.copilot;
      window.__copilot = copilot;

      if (copilot.loading) {
        copilot.loading.connect(v => setLoading(Boolean(v)));
      }
      
      if (copilot.resultReady) {
        copilot.resultReady.connect(text => {
          setLoading(false);
          renderResult(text);
        });
      }
    });
  }

  window.scanWindow = () => { if(window.__copilot) setTimeout(() => window.__copilot.scan_window(), 50); };
  window.uploadImage = () => { if(window.__copilot) setTimeout(() => window.__copilot.upload_image(), 50); };
  window.captureCamera = () => { if(window.__copilot) setTimeout(() => window.__copilot.capture_camera(), 50); };

  initWebChannel();
})();
</script>
</body>
</html>